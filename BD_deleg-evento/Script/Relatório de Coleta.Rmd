---
title: "Relatório de Coleta"
output: pdf_document
date: "`r Sys.Date()`"
---

Esse relatório apresenta o progresso da coleta de dados do projeto "Pluralização da política externa ambiental brasileira". Apresentamos aqui dados básicos sobre a versão mais atualizada do Banco de Dados de Atores e Eventos da Política Externa Ambiental Brasileira (1970-2018). 
O relatório traz, para fácil acesso, os números atualizados de eventos e participantes incluídos na base. O principal ponto do arquivo, porém, é apresentar os dados de sucesso/fracasso na coleta dos dados, que permitem avaliar eventuais vieses de seleção no banco.

## Versão do banco
Relatório mais recente: "`r Sys.Date()`"
```{r, include=FALSE}
get_latest <- function(basefilename){
  file_name <- list.files(pattern = paste0(basefilename, "-.+\\.csv"))
  date <- stringr::str_remove_all(file_name, paste0(basefilename,"-", "|\\.csv"))
  date
}
```

*Versão da planilha deleg*: `r get_latest("deleg")`
*Versão da planilha orgs*: `r get_latest("orgs")`
*Versão da planilha class*: `r get_latest("class")`

[Falta automatizar aqui a versão da planilha de eventos cf a data. Nesse momento, estou usando a eventos_v4.csv, atualizada em 05/07/2022. Será atualizada para uma v5, com os MPs etc, antes de rodar o relatório.]


## Preparo do banco
Antes de apresentar os dados, é preciso construir o banco principal integrando os dados dos bancos parciais (eventos, delegações, indivíduos) no R. O script para isso será incluído aqui, mas rodado de forma silenciosa.
- Carregando as bases separadas
```{r, echo=F}
## Carregando pacotes ------------
library(tidyverse)

## Importando os dados ------------
getlatest_file <- function(basefilename){
  list.files(pattern = paste0(basefilename, "-.+\\.csv"))
}

deleg <- read_delim(getlatest_file("deleg"), 
                    ";", escape_double = FALSE, 
                    col_types = cols(
                      #X1 = col_skip()
                      ), 
                    #locale = locale(encoding = "ISO-8859-1"), 
                    trim_ws = TRUE)

orgs <- read_delim(getlatest_file("orgs"), 
                   ";", escape_double = FALSE, 
                   col_types = cols(
                     #X1 = col_skip()
                     ), 
                   locale = locale(encoding = "ISO-8859-1"), 
                   trim_ws = TRUE) # %>% distinct()

class <- read_delim(getlatest_file("class"), 
                   ";", escape_double = FALSE, 
                   col_types = cols(
                     #X1 = col_skip()
                     ), 
                   locale = locale(encoding = "ISO-8859-1"), 
                   trim_ws = TRUE) # %>% distinct()


eventos <- read_delim("eventos_v4.csv", ## atualizar eventos e colocar em formato data
                      ";", escape_double = FALSE, 
                      #locale = locale(encoding = "UTF-8"), 
                      trim_ws = TRUE)
```

- Integrando as bases em uma
```{r, echo = FALSE}
# Criando deleg_completo (deleg+orgs+class) --------
orgs_classificado <- left_join(orgs, class) %>% select(-c(org_sujo, org_detalhe_sujo))
# N de rows aumenta, porque tem orgs que ficaram apenas na class e saíram da lista orgs (foram erros na padronização e corrigidos posteriormente)
# Teste (resultado deve ser tibble vazio): left_join(orgs, class, by = "id_org_unica") %>% filter(org_limpo.x != org_limpo.y)

deleg_completo <- deleg %>% select(-c(org, org_detalhe)) %>% left_join(orgs_classificado, by = "id_org_dupla")

# Limpando deleg_completo
deleg_completo <- deleg_completo %>% mutate(across(where(is.character), str_trim))

rm(deleg, orgs, class)
```

```{r}
# Limpando a base dos eventos --------

### Limpar e renomear colunas
eventos <- eventos %>% select(-c(`Código ONU`, Comentário, `Formato lista`, 
                                 `Aberto?`, `Questões a atentar`, 
                                 Corrigendum, Local)) %>% #retira colunas irrelevantes
  rename(#renomeia colunas
    conf = `Nome do evento`,
    conference = `Conf/Conv`,
    tema = `Regime/Tema`,
    data = Data,
    location = Locale,
    tipo_evento = `Tipo evento`,
    infMEA_list = `Lista MEA?`,
    coleta = `Coleta?`,
    proces = `Proces.?` 
  )

eventos <- eventos %>% mutate(
  data = if_else(str_count(data)==4, #se falta o mês (só ano)
                 paste0(data, "-01"), #padroniza como janeiro
                 data)) %>% 
  mutate(
    data = if_else(is.na(data)== F,
                   paste0(data, "-01"), #padroniza data no dia 1 do mês
                   data)
  ) %>% mutate(data = lubridate::ymd(data), 
               ano = lubridate::year(lubridate::ymd(data))) 

eventos <- eventos %>% mutate(across(where(is.character), str_trim))
```


[criado o deleg completo e a planilha de eventos limpa, gerar os dados a serem apresentados baixo]

## Descrição geral do banco
### Processo de coleta e limitações do banco a serem levados em consideração

- Descrever o processo de escolha das conferências a serem incluídas

- A partir de 2015, os dados referentes às COPs da UNFCCC sofrem uma mudança importante: o Brasil passa a registrar os membros da delegação oriundos da sociedade civil como 'party overflow'. Participantes nessa categoria não têm seu nome incluído nas listas oficiais de participantes, o que representa importante quebra nos nossos dados.

### Base total
A base inclui alguns eventos pré 1970 e pós 2018, mas a coleta não foi sistemática nesses períodos. Seguem abaixo os dados para as delegações e eventos **como um todo, isto é, sem filtros referentes a datas**:

*Número total de eventos identificados*:
*Número total de eventos coletados*:

*Número total de organizações presentes nas delegações*:
*Número total de participações/nomes nas delegações (inclui repetições dos mesmos indivíduos)*:
*Número total de indivíduos presentes nas delegações (após limpeza dos dados via Google Refine)*:


*Número de eventos com delegações brasileiras vazias (ie, para os quais foi obtida a lista de participantes, mas o Brasil não enviou delegação)*:

### Base filtrada:
A base inclui alguns eventos pré 1970 e pós 2018, mas a coleta não foi sistemática nesses períodos. Seguem abaixo os dados para as delegações e eventos considerando **apenas o período 1970-2018**:

```{r, results='hide'}

## filtrar a base

```


*Número total de eventos identificados*:
*Número total de eventos coletados*:

*Número total de organizações presentes nas delegações*:
*Número total de participações/nomes nas delegações (inclui repetições dos mesmos indivíduos)*:
*Número total de indivíduos presentes nas delegações (após limpeza dos dados via Google Refine)*:


*Número de eventos com delegações brasileiras vazias (ie, para os quais foi obtida a lista de participantes, mas o Brasil não enviou delegação)*:

## Grau de sucesso da coleta: percentual de eventos incluídos na base
Os dados abaixo são apresentados levando em conta a base filtrada, isto é, **apenas os eventos no período 1970-2018**.


Eventos coletados/identificados ao longo do tempo
```{r}

```

### Variação do sucesso da coleta por tema e tipo de evento
```{r}

```



## Lista de conferências incluídas na base
[talvez valesse incluir, além de uma lista como a colocada de apêndice no Git, uma tabela dinâmica nos moldes da usada na minha planilha eventos do excel]




